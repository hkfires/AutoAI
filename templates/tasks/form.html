{% extends "base.html" %}

{% block title %}{% if task %}编辑任务{% else %}新建任务{% endif %} - AutoAI{% endblock %}

{% block content %}
<h1>{% if task %}编辑任务{% else %}新建任务{% endif %}</h1>

<form method="POST" action="{{ action_url }}">
    <div class="form-group">
        <label for="name">任务名称 *</label>
        <input type="text" id="name" name="name" value="{{ task.name if task else '' }}" required
               maxlength="100" placeholder="例如：每日问候">
    </div>

    <div class="form-group">
        <label for="api_endpoint">API 端点地址 *</label>
        <input type="url" id="api_endpoint" name="api_endpoint"
               value="{{ task.api_endpoint if task else 'https://api.openai.com/v1/chat/completions' }}"
               required maxlength="500">
    </div>

    <div class="form-group">
        <label for="api_key">API 密钥 {% if task %}(留空保持原值){% else %}*{% endif %}</label>
        <input type="password" id="api_key" name="api_key"
               placeholder="sk-..." maxlength="500" {% if not task %}required{% endif %}>
    </div>

    <div class="form-group">
        <label for="model_select">AI 模型 *</label>
        <select id="model_select" onchange="toggleCustomModel(true)">
            <option value="gemini-claude-sonnet-4-5" {% if task and task.model == 'gemini-claude-sonnet-4-5' %}selected{% elif not task %}selected{% endif %}>
                gemini-claude-sonnet-4-5
            </option>
            <option value="custom" {% if task and task.model and task.model != 'gemini-claude-sonnet-4-5' %}selected{% endif %}>
                自定义...
            </option>
        </select>
        <input type="text" id="model_custom" name="model"
               value="{{ task.model if task else 'gemini-claude-sonnet-4-5' }}"
               maxlength="100" placeholder="输入模型名称" required>
    </div>

    <div class="form-group">
        <label for="schedule_type">调度类型 *</label>
        <select id="schedule_type" name="schedule_type" required onchange="toggleScheduleFields()">
            <option value="interval" {% if not task or task.schedule_type == 'interval' %}selected{% endif %}>
                间隔模式
            </option>
            <option value="fixed_time" {% if task and task.schedule_type == 'fixed_time' %}selected{% endif %}>
                固定时间模式
            </option>
        </select>
    </div>

    <div class="form-group" id="interval-group">
        <label>执行间隔</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="interval_minutes" name="interval_minutes"
                   value="{{ task.interval_minutes if task and task.interval_minutes else 0 }}" min="0" style="width: 80px;">
            <span>分钟</span>
            <input type="number" id="interval_seconds" name="interval_seconds"
                   value="{{ task.interval_seconds if task and task.interval_seconds else 0 }}" min="0" style="width: 80px;">
            <span>秒</span>
        </div>
    </div>

    <div class="form-group hidden" id="fixed-time-group">
        <label for="fixed_time">固定时间 (HH:MM)</label>
        <input type="time" id="fixed_time" name="fixed_time"
               value="{{ task.fixed_time if task else '09:00' }}">
    </div>

    <div class="form-group">
        <label for="message_content">消息内容 *</label>
        <textarea id="message_content" name="message_content" required
                  placeholder="输入要发送给 AI 的消息...">{{ task.message_content if task else '' }}</textarea>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" name="enabled" value="true"
                   {% if not task or task.enabled %}checked{% endif %}>
            启用任务
        </label>
    </div>

    <div style="margin-top: 20px;">
        <button type="submit" class="btn btn-primary">保存</button>
        <a href="/" class="btn btn-secondary">取消</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
function toggleScheduleFields() {
    const scheduleType = document.getElementById('schedule_type').value;
    const intervalGroup = document.getElementById('interval-group');
    const fixedTimeGroup = document.getElementById('fixed-time-group');

    if (scheduleType === 'interval') {
        intervalGroup.classList.remove('hidden');
        fixedTimeGroup.classList.add('hidden');
        document.getElementById('fixed_time').required = false;
    } else {
        intervalGroup.classList.add('hidden');
        fixedTimeGroup.classList.remove('hidden');
        document.getElementById('fixed_time').required = true;
    }
}

function validateIntervalForm(event) {
    const scheduleType = document.getElementById('schedule_type').value;
    if (scheduleType === 'interval') {
        const minutes = parseInt(document.getElementById('interval_minutes').value) || 0;
        const seconds = parseInt(document.getElementById('interval_seconds').value) || 0;
        if (minutes <= 0 && seconds <= 0) {
            event.preventDefault();
            alert('间隔时间必须大于 0');
            return false;
        }
    }
    return true;
}

function toggleCustomModel(isUserAction) {
    const modelSelect = document.getElementById('model_select');
    const modelCustom = document.getElementById('model_custom');

    if (modelSelect.value === 'custom') {
        modelCustom.style.display = 'block';
        // Only clear value when user manually selects "custom", not on page load
        if (isUserAction) {
            modelCustom.value = '';
            modelCustom.focus();
        }
    } else {
        modelCustom.style.display = 'none';
        modelCustom.value = modelSelect.value;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleScheduleFields();
    toggleCustomModel(false);
    // Add form submit validation
    document.querySelector('form').addEventListener('submit', validateIntervalForm);
});
</script>
{% endblock %}
