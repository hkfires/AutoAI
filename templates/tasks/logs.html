{% extends "base.html" %}

{% block title %}执行日志 - {{ task.name }} - AutoAI{% endblock %}

{% block content %}
<h1>执行日志：{{ task.name }}</h1>

<p style="margin-bottom: 20px;">
    <a href="/" class="btn btn-secondary">&larr; 返回任务列表</a>
</p>

<!-- 统计信息卡片 -->
<div class="dashboard" style="margin-bottom: 20px;">
    <div class="dashboard-card">
        <div class="card-value">{{ stats.total_executions }}</div>
        <div class="card-label">总执行次数</div>
    </div>
    <div class="dashboard-card">
        <div class="card-value">{{ stats.success_rate }}</div>
        <div class="card-label">成功率</div>
    </div>
    <div class="dashboard-card">
        <div class="card-value" style="font-size: 1em;">{{ stats.recent_trend }}</div>
        <div class="card-label">最近 7 天</div>
    </div>
</div>

<!-- 筛选表单 -->
<form method="GET" class="filter-form">
    <div class="filter-group">
        <label for="status">状态</label>
        <select name="status" id="status">
            <option value="">全部</option>
            <option value="success" {% if filters.status == 'success' %}selected{% endif %}>成功</option>
            <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>失败</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="start_date">开始日期</label>
        <input type="date" name="start_date" id="start_date" value="{{ filters.start_date or '' }}">
    </div>
    <div class="filter-group">
        <label for="end_date">结束日期</label>
        <input type="date" name="end_date" id="end_date" value="{{ filters.end_date or '' }}">
    </div>
    <button type="submit" class="btn btn-primary">筛选</button>
    <button type="button" class="btn btn-secondary" onclick="window.location.href='/tasks/{{ task.id }}/logs'">清除</button>
</form>

<table>
    <thead>
        <tr>
            <th>执行时间</th>
            <th>状态</th>
            <th>响应/错误信息</th>
        </tr>
    </thead>
    <tbody>
        {% for log in logs %}
        <!-- 主行：可点击展开 -->
        <tr class="log-row {% if log.status == 'failed' %}row-warning{% endif %}">
            <td><span class="local-time" data-utc="{{ log.executed_at.isoformat() }}Z">{{ log.executed_at.strftime('%Y-%m-%d %H:%M:%S') }}</span></td>
            <td>
                {% if log.status == 'success' %}
                    <span class="status-success">✓ 成功</span>
                {% else %}
                    <span class="status-failed">✗ 失败</span>
                {% endif %}
            </td>
            <td>{{ (log.response_summary or log.error_message or '-')[:50] }}{% if (log.response_summary or log.error_message or '') | length > 50 %}...{% endif %}</td>
        </tr>
        <!-- 详情行：默认隐藏 -->
        <tr class="detail-row hidden">
            <td colspan="3">
                <div class="detail-content">
                    <div class="detail-item">
                        <span class="detail-label">执行时间：</span>
                        <span class="local-time" data-utc="{{ log.executed_at.isoformat() }}Z">{{ log.executed_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">状态：</span>
                        {% if log.status == 'success' %}成功{% else %}失败{% endif %}
                    </div>
                    {% if log.status == 'success' %}
                    <div class="detail-item">
                        <span class="detail-label">响应摘要：</span>
                        <pre style="white-space: pre-wrap;">{{ log.response_summary or '无' }}</pre>
                    </div>
                    {% else %}
                    <div class="detail-item">
                        <span class="detail-label">错误信息：</span>
                        <pre style="white-space: pre-wrap; color: #dc3545;">{{ log.error_message or '未知错误' }}</pre>
                    </div>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="3" style="text-align: center; color: #666;">暂无执行记录</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- 分页导航 -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}&status={{ filters.status or '' }}&start_date={{ filters.start_date or '' }}&end_date={{ filters.end_date or '' }}" class="page-link">上一页</a>
    {% else %}
    <span class="page-link disabled">上一页</span>
    {% endif %}

    <span class="page-info">第 {{ page }} / {{ total_pages }} 页</span>

    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}&status={{ filters.status or '' }}&start_date={{ filters.start_date or '' }}&end_date={{ filters.end_date or '' }}" class="page-link">下一页</a>
    {% else %}
    <span class="page-link disabled">下一页</span>
    {% endif %}
</div>
{% endif %}

<p style="margin-top: 10px; color: #666; font-size: 0.9em;">
    显示 {{ logs|length }} 条记录（共 {{ total_count }} 条{% if total_pages > 1 %}，第 {{ page }} / {{ total_pages }} 页{% endif %}）
</p>
{% endblock %}

{% block scripts %}
<script>
    // Convert UTC times to local timezone
    document.querySelectorAll('.local-time').forEach(function(el) {
        var utc = el.getAttribute('data-utc');
        if (utc) {
            var date = new Date(utc);
            var options = { year: 'numeric', month: '2-digit', day: '2-digit',
                           hour: '2-digit', minute: '2-digit', second: '2-digit' };
            el.textContent = date.toLocaleString('zh-CN', options);
        }
    });

    // Toggle log detail rows
    document.querySelectorAll('.log-row').forEach(function(row) {
        row.addEventListener('click', function() {
            var detailRow = this.nextElementSibling;
            if (detailRow && detailRow.classList.contains('detail-row')) {
                detailRow.classList.toggle('hidden');
                this.classList.toggle('expanded');
            }
        });
    });
</script>
{% endblock %}
